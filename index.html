<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KittyAIChat ‚Äî Gemini 2.5 Flash</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Identity (One-tap / button) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Google Generative AI (ESM import map) -->
  <script type="importmap">
  {
    "imports": {
      "@google/generative-ai": "https://esm.run/@google/generative-ai"
    }
  }
  </script>

  <style>
    .slide-left { transform: translateX(0); transition: transform .25s ease; }
    .slide-left.hidden { transform: translateX(-100%); }
    .typing-dots span { display:inline-block; width:6px; height:6px; margin-right:4px; border-radius:999px; background:currentColor; animation: blink 1s infinite; }
    .typing-dots span:nth-child(2){ animation-delay:.2s } .typing-dots span:nth-child(3){ animation-delay:.4s }
    @keyframes blink { 0%,80%,100%{ opacity:0 } 40%{ opacity:1 } }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

<!-- =========================
     LANDING / START PAGE (default)
     ========================= -->
<div id="landing-page" class="min-h-screen flex flex-col items-center justify-center p-8">
  <div class="max-w-5xl w-full grid md:grid-cols-2 gap-8 items-center">
    <div>
      <h1 class="text-4xl font-extrabold">Responsive AI Chatbot ‚Äî Powered by Gemini 2.5 Flash</h1>
      <p class="mt-4 text-gray-600 dark:text-gray-300">A single-file demo that connects to Google Gemini (replace the API key). Guest name, Google login, chat history, and a modern UX ‚Äî ready to extend to production with a secure backend.</p>
      <div class="mt-6 flex gap-3">
        <button id="open-chat-btn" class="px-5 py-3 bg-blue-600 text-white rounded-lg">Open Chat</button>
        <a href="#how" id="how-link" class="px-5 py-3 border rounded-lg">How it works</a>
      </div>
    </div>
    <div>
      <div class="rounded-xl border p-4 bg-gradient-to-br from-blue-50 to-purple-50 dark:from-gray-800 dark:to-purple-900">
        <div class="text-sm uppercase opacity-70">Live Demo</div>
        <div class="mt-4 font-medium">Click Open Chat to begin ‚Äî try: "Explain quantum computing"</div>
        <div class="mt-2 text-sm opacity-70">Features: persistent history, export, dark mode, avatars, quick prompts.</div>
      </div>
    </div>
  </div>
  <footer class="mt-12 text-sm opacity-70">¬© <span id="year"></span> KittyAIChat ‚Äî Demo</footer>
</div>

<!-- =========================
     LOGIN PAGE (shown when Open Chat clicked)
     ========================= -->
<div id="login-page" class="hidden min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">Sign in to KittyAIChat</h1>
      <button id="back-to-landing" class="px-3 py-1 rounded-md border text-sm">‚Üê Back</button>
    </div>
    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Sign in with Google or continue as guest</p>

    <!-- Google One-tap / Sign-in -->
    <div id="g_id_onload"
         data-client_id="611704066903-0f5on12hnn2leafh413v2r5g6vtjc9ip.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_select="false"
         data-itp_support="true"></div>

    <div class="g_id_signin flex justify-center mb-4" data-type="standard"></div>

    <!-- Guest name + buttons -->
    <div class="flex flex-col gap-3">
      <input id="guest-name" type="text" placeholder="Enter guest name (optional)" class="px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700" />
      <div class="flex gap-3">
        <button id="guest-continue" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg">Continue as Guest</button>
        <button id="demo-continue" class="px-4 py-2 border rounded-lg">Demo (no AI)</button>
      </div>
      <p class="text-xs text-gray-500 mt-3">Tip: Serve on <code>http://localhost</code> so Google Sign-in works (won't work with file://).</p>
    </div>
  </div>
</div>

<!-- =========================
     MAIN APP (Chat + Sidebar) - shown after login landing -> chat
     ========================= -->
<div id="app" class="hidden min-h-screen flex flex-col">

  <!-- Header -->
  <header class="flex items-center justify-between px-4 py-3 border-b dark:border-gray-700 bg-white/70 dark:bg-neutral-900/60 sticky top-0 z-20">
    <div class="flex items-center gap-3">
      <button id="history-toggle" title="History" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800">üìú</button>

      <div id="user-avatar-header" class="w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-700 flex items-center justify-center text-white font-semibold"></div>

      <div>
        <div id="user-name-header" class="font-semibold">User</div>
        <div id="user-sub-header" class="text-xs opacity-70">Signed in</div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <button id="theme-toggle" class="px-2 py-1 rounded-md border">üåô</button>
      <button id="new-session-btn" class="px-3 py-1 rounded-md border">+ New Chat</button>
      <button id="export-all-btn" class="px-3 py-1 rounded-md border">Export All</button>
      <button id="logout-btn" class="px-3 py-1 rounded-md border">Logout</button>
    </div>
  </header>

  <div class="flex flex-1 relative">

    <!-- Sidebar (history) -->
    <aside id="history-sidebar" class="w-80 bg-white dark:bg-gray-800 border-r dark:border-gray-700 h-full absolute inset-y-0 left-0 z-30 slide-left hidden">
      <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between">
        <div class="font-semibold">History</div>
        <button id="history-close" class="p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">‚úñ</button>
      </div>
      <div id="sessions-list" class="p-3 overflow-y-auto" style="max-height: calc(100vh - 160px);"></div>
      <div class="p-3 border-t dark:border-gray-700">
        <button id="sidebar-new" class="w-full px-3 py-2 bg-blue-600 text-white rounded-lg">New Chat</button>
      </div>
    </aside>

    <!-- Chat area -->
    <main class="flex-1 flex flex-col">
      <div id="messages-wrap" class="flex-1 overflow-y-auto p-4 space-y-4 bg-white dark:bg-gray-900"></div>

      <div class="px-4 pb-4">
        <div class="flex flex-wrap gap-2 mb-3">
          <button class="quick-prompt px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-sm">Explain quantum computing</button>
          <button class="quick-prompt px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-sm">Summarize today's news</button>
          <button class="quick-prompt px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 text-sm">Give me fitness tips</button>
        </div>
        <div class="flex gap-2">
          <input id="chat-input" class="flex-1 p-3 border rounded-lg dark:bg-gray-800 dark:border-gray-700" placeholder="Type a message. Enter to send" />
          <button id="send-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Send</button>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- =========================
     MAIN JS: App logic
     ========================= -->
<script type="module">
  import { GoogleGenerativeAI } from "@google/generative-ai";

  // ---------------------------
  // Placeholders (replace these)
  // ---------------------------
  const GOOGLE_CLIENT_ID = "611704066903-0f5on12hnn2leafh413v2r5g6vtjc9ip.apps.googleusercontent.com";          // paste your Google OAuth client id
  const GEMINI_API_KEY_PLACEHOLDER = "AIzaSyB2jhh9sjespdE_nUPyN_fJdWPfjjCRURo"; // paste your Gemini API key

  // Initialize Gemini client (user will paste key into placeholder)
  const genAI = new GoogleGenerativeAI(GEMINI_API_KEY_PLACEHOLDER);
  const model = genAI.getGenerativeModel?.({ model: "gemini-2.5-flash" });

  // ---------------------------
  // Storage / Sessions helpers
  // ---------------------------
  const STORAGE_KEY = "nova:sessions";
  function loadSessions(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }catch{ return []; } }
  function saveSessions(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

  let sessions = loadSessions();
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function niceTitle(d){ return `Chat - ${d.toLocaleString()}`; }

  // Session management
  let currentSessionId = null;
  let currentUser = { name: "Guest", avatar: "", color: "#6B7280", isGoogle: false };
  let isDemoMode = false;

  // Utility
  function randomColor(){ const colors = ["#6B7280","#EF4444","#10B981","#3B82F6","#F59E0B","#8B5CF6","#EC4899","#14B8A6"]; return colors[Math.floor(Math.random()*colors.length)]; }
  function escapeHtml(str=""){ return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

  // Load/create session helpers
  function getSession(id){ return sessions.find(s=>s.id===id); }
  function createNewSession(title){
    const now = new Date();
    const s = { id: uid(), title: title || niceTitle(now), createdAt: now.toISOString(), messages: [] };
    sessions.unshift(s);
    saveSessions(sessions);
    currentSessionId = s.id;
    renderSessionsList();
    renderMessages();
    return s;
  }
  function saveCurrentSession(){ saveSessions(sessions); renderSessionsList(); }

  // Add message
  function addMessage(role, content){
    if(!currentSessionId) createNewSession();
    const s = getSession(currentSessionId);
    s.messages.push({ role, content, time: new Date().toLocaleTimeString() });
    saveCurrentSession();
  }

  // ---------------------------
  // DOM refs
  // ---------------------------
  const landingPage = document.getElementById("landing-page");
  const loginPage = document.getElementById("login-page");
  const appDiv = document.getElementById("app");
  const historySidebar = document.getElementById("history-sidebar");
  const sessionsListEl = document.getElementById("sessions-list");
  const messagesWrap = document.getElementById("messages-wrap");
  const userNameHeader = document.getElementById("user-name-header");
  const userAvatarHeader = document.getElementById("user-avatar-header");
  const openChatBtn = document.getElementById("open-chat-btn");

  // initial year
  document.getElementById("year").textContent = new Date().getFullYear();

  // ---------------------------
  // Render sessions list (sidebar)
  // ---------------------------
  function renderSessionsList(){
    sessionsListEl.innerHTML = "";
    if(!sessions.length){
      sessionsListEl.innerHTML = `<div class="text-sm text-gray-500 p-3">No sessions yet</div>`;
      return;
    }
    sessions.forEach(s => {
      const row = document.createElement("div");
      row.className = "p-3 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-between gap-2";
      row.innerHTML = `
        <div class="flex-1">
          <div class="font-medium">${escapeHtml(s.title)}</div>
          <div class="text-xs opacity-70">${new Date(s.createdAt).toLocaleString()}</div>
          <div class="text-xs opacity-60 mt-1">${s.messages.length} messages</div>
        </div>
        <div class="flex gap-2 ml-2">
          <button data-load="${s.id}" class="px-2 py-1 text-xs border rounded">Load</button>
          <button data-del="${s.id}" class="px-2 py-1 text-xs border rounded text-red-500">Delete</button>
        </div>
      `;
      sessionsListEl.appendChild(row);
    });

    sessionsListEl.querySelectorAll("[data-load]").forEach(btn => btn.onclick = e => {
      const id = e.currentTarget.getAttribute("data-load");
      switchToSession(id);
    });
    sessionsListEl.querySelectorAll("[data-del]").forEach(btn => btn.onclick = e => {
      const id = e.currentTarget.getAttribute("data-del");
      if(confirm("Delete this session?")) {
        sessions = sessions.filter(x => x.id !== id);
        if(currentSessionId === id) currentSessionId = sessions.length ? sessions[0].id : null;
        saveSessions(sessions);
        renderSessionsList();
        renderMessages();
      }
    });
  }

  // ---------------------------
  // Render messages
  // ---------------------------
  function renderMessages(){
    const messagesEl = document.getElementById("messages-wrap") || messagesWrap;
    messagesEl.innerHTML = "";
    const s = getSession(currentSessionId);
    if(!s){
      messagesEl.innerHTML = `<div class="p-6 text-sm text-gray-500">Start a new chat or open a previous session from History.</div>`;
      return;
    }

    s.messages.forEach(m => {
      const wrapper = document.createElement("div");
      wrapper.className = `flex ${m.role === "user" ? "justify-end" : "justify-start"}`;
      const bubble = document.createElement("div");
      bubble.className = `max-w-[80%] px-3 py-2 rounded-xl text-sm ${m.role === "user" ? "bg-blue-600 text-white" : "bg-gray-100 dark:bg-gray-800 dark:text-gray-100"}`;
      let avatarHTML = "";
      if(m.role === "user"){
        if(currentUser.isGoogle && currentUser.avatar) {
          avatarHTML = `<img src="${currentUser.avatar}" class="w-7 h-7 rounded-full inline-block mr-2">`;
        } else {
          avatarHTML = `<span class="inline-block w-7 h-7 rounded-full text-white font-semibold mr-2 flex items-center justify-center" style="background:${currentUser.color}">${currentUser.avatar}</span>`;
        }
      } else {
        avatarHTML = `<span class="inline-block mr-2">‚ú®</span>`;
      }
      bubble.innerHTML = `<div class="flex items-start">${avatarHTML}<div><div>${escapeHtml(m.content)}</div><div class="text-xs opacity-60 mt-1">${m.time || ""}</div></div></div>`;
      wrapper.appendChild(bubble);
      messagesEl.appendChild(wrapper);
    });

    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // ---------------------------
  // Chat actions (send)
  // ---------------------------
  async function sendCurrentMessage(){
    const inputEl = document.getElementById("chat-input");
    const val = inputEl.value.trim();
    if(!val) return;
    addMessage("user", val);
    renderMessages();
    inputEl.value = "";

    // add temporary typing indicator
    const s = getSession(currentSessionId);
    s.messages.push({ role: "assistant", content: "‚è≥ Gemini is typing...", time: new Date().toLocaleTimeString(), _typing: true });
    renderMessages();

    // Call Gemini (or demo)
    try {
      let replyText = "[No response]";
      if(isDemoMode){
        await new Promise(r=>setTimeout(r,700));
        replyText = "This is a demo reply. Swap in your Gemini API key to get real responses.";
      } else {
        let result;
        try { result = await model.generateContent(val); } catch(e) {
          result = await model.generateContent?.({ prompt: val }).catch(()=>{ throw e; });
        }
        try {
          replyText = typeof result.response?.text === "function" ? result.response.text() : (result?.response?.text || result?.text || JSON.stringify(result));
        } catch(e) { replyText = JSON.stringify(result); }
      }

      const s2 = getSession(currentSessionId);
      if(s2 && s2.messages.length && s2.messages[s2.messages.length-1]._typing) s2.messages.pop();
      s2.messages.push({ role: "assistant", content: replyText, time: new Date().toLocaleTimeString() });
      saveCurrentSession();
      renderMessages();

    } catch(err){
      console.error(err);
      const s3 = getSession(currentSessionId);
      if(s3 && s3.messages.length && s3.messages[s3.messages.length-1]._typing) s3.messages.pop();
      s3.messages.push({ role: "assistant", content: "‚ö†Ô∏è Error: " + (err.message || err), time: new Date().toLocaleTimeString() });
      saveCurrentSession();
      renderMessages();
    }
  }

  // Bind controls & UI buttons
  function bindChatControls(){
    document.querySelectorAll(".quick-prompt").forEach(btn => {
      btn.onclick = () => { document.getElementById("chat-input").value = btn.textContent; sendCurrentMessage(); };
    });

    document.getElementById("send-btn").onclick = sendCurrentMessage;
    document.getElementById("chat-input").addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !e.shiftKey){ e.preventDefault(); sendCurrentMessage(); }
    });

    document.getElementById("new-session-btn").onclick = () => { createNewSession(); renderMessages(); };
    document.getElementById("sidebar-new").onclick = () => { createNewSession(); historySidebar.classList.add("hidden"); renderMessages(); };

    document.getElementById("export-all-btn").onclick = () => {
      if(!sessions.length) return alert("No sessions to export.");
      let text = "KittyAIChat - All Sessions\n\n";
      sessions.forEach(s => {
        text += `== ${s.title} ==\n`;
        s.messages.forEach(m => text += `[${m.role.toUpperCase()}] ${m.time}\n${m.content}\n\n`);
        text += "\n";
      });
      const blob = new Blob([text], {type:"text/plain"}); const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
      a.download = `novachat-sessions-${new Date().toISOString().slice(0,19)}.txt`; document.body.appendChild(a); a.click(); a.remove();
    };

    document.getElementById("history-toggle").onclick = () => { historySidebar.classList.remove("hidden"); renderSessionsList(); };
    document.getElementById("history-close").onclick = () => { historySidebar.classList.add("hidden"); };
    document.getElementById("sidebar-new").onclick = () => { createNewSession(); renderMessages(); historySidebar.classList.add("hidden"); };

    document.getElementById("logout-btn").onclick = () => {
      if(confirm("Sign out and return to landing?")) {
        // show landing page
        appDiv.classList.add("hidden");
        landingPage.classList.remove("hidden");
        // reset state
        currentUser = { name: "Guest", avatar: "", color: "#6B7280", isGoogle: false };
        currentSessionId = null;
      }
    };

    document.getElementById("theme-toggle").onclick = () => { document.documentElement.classList.toggle("dark"); };
  }

  // Switch session
  function switchToSession(id){
    saveCurrentSession();
    currentSessionId = id;
    historySidebar.classList.add("hidden");
    renderMessages();
  }

  // ---------------------------
  // Sign-in flows
  // ---------------------------
  // Google OAuth callback (will be called by Google button)
  window.handleCredentialResponse = (resp) => {
    try {
      const profile = parseJwt(resp.credential);
      currentUser.name = profile.name || "Google User";
      currentUser.avatar = profile.picture || "";
      currentUser.isGoogle = true;
      isDemoMode = false;
      afterLoginGotoChat();
    } catch(e){
      console.error("Google login parse failed", e);
      alert("Google login failed.");
    }
  };

  // Guest continue
  document.getElementById("guest-continue").onclick = () => {
    const name = (document.getElementById("guest-name").value || "").trim() || "Guest";
    currentUser.name = name;
    currentUser.avatar = name.charAt(0).toUpperCase();
    currentUser.color = randomColor();
    currentUser.isGoogle = false;
    isDemoMode = false;
    afterLoginGotoChat();
  };

  // Demo continue
  document.getElementById("demo-continue").onclick = () => {
    currentUser.name = "Demo";
    currentUser.avatar = "D";
    currentUser.color = randomColor();
    currentUser.isGoogle = false;
    isDemoMode = true;
    afterLoginGotoChat();
  };

  // Back to landing from login
  document.getElementById("back-to-landing").onclick = () => {
    loginPage.classList.add("hidden");
    landingPage.classList.remove("hidden");
  };

  // Open Chat (from landing) -> go to login page
  document.getElementById("open-chat-btn").onclick = () => {
    landingPage.classList.add("hidden");
    loginPage.classList.remove("hidden");
  };

  // After login: directly open chat page
  function afterLoginGotoChat(){
    loginPage.classList.add("hidden");
    appDiv.classList.remove("hidden");
    // header info
    document.getElementById("user-name-header").textContent = currentUser.name;
    const headerAvatar = document.getElementById("user-avatar-header");
    headerAvatar.innerHTML = "";
    if(currentUser.isGoogle && currentUser.avatar){
      headerAvatar.innerHTML = `<img src="${currentUser.avatar}" class="w-10 h-10 rounded-full" />`;
      headerAvatar.style.background = "";
    } else {
      headerAvatar.textContent = currentUser.avatar || currentUser.name.charAt(0).toUpperCase();
      headerAvatar.style.background = currentUser.color || randomColor();
    }

    // ensure at least one session exists
    if(!sessions.length) createNewSession();
    if(!currentSessionId) currentSessionId = sessions[0].id;
    renderSessionsList();
    renderMessages();
    bindChatControls();
  }

  // ---------------------------
  // JWT parse helper
  // ---------------------------
  function parseJwt(token){
    try{
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c){ return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2); }).join(''));
      return JSON.parse(jsonPayload);
    }catch(e){ return {}; }
  }

  // ---------------------------
  // Create initial session if none
  // ---------------------------
  if(!sessions.length){
    const s = createNewSession();
    currentSessionId = s.id;
  } else {
    currentSessionId = sessions[0].id;
  }
  renderSessionsList();
  renderMessages();

  // Expose debug helpers
  window.__novachat = { sessions, save: ()=>saveSessions(sessions), create: createNewSession };
</script>
</body>
</html>
